using Microsoft.Data.SqlClient;

namespace ConsoleApp1
{
    internal class Program
    {
        static void Main(string[] args)
        {
            List<string> employeesList = new List<string>();
            string connectionString = "Server=(localdb)\\MSSQLLocalDB;Database=SoftUni;Trusted_Connection=True;";
            var connection = new SqlConnection(connectionString);
            //string query = "SELECT TOP (@top) * FROM Employees WHERE DepartmentID = @DepId";
            //string sql = "SELECT TOP (@top) * FROM Employees WHERE DepartmentID = @DepId ORDER BY Salary DESC;";
            string s = @"SELECT e.FirstName, e.LastName, ad.AddressText, t.[Name]
                FROM Employees e
                JOIN Addresses ad ON ad.AddressID = e.AddressID
                JOIN Towns t ON t.TownID = ad.TownID
                WHERE t.Name = @townName";
            var cmd = new SqlCommand(s, connection);
            cmd.Parameters.AddWithValue("@DepId", 1);
            cmd.Parameters.Add("@top", System.Data.SqlDbType.Int).Value = 10;
            cmd.Parameters.Add("@townName", System.Data.SqlDbType.NVarChar, 20).Value = "Sofia";

            connection.Open();

            var dbReader = cmd.ExecuteReader();

            while (dbReader.Read())
            {
                //string firstName = dbReader.GetString(1);
                //string lastName = dbReader["LastName"].ToString()!;
                //employeesList.Add($"{firstName} {lastName}");
                Console.WriteLine($"{dbReader["FirstName"]} " +
                    $"{dbReader["LastName"]} -> {dbReader["Name"]}");
            }
            connection.Close();
            // Console.WriteLine(string.Join("\n", employeesList));

            //INSERT
            string query = "INSERT INTO Towns(Name) VALUES (@townName)";
            connection.Open();
            var insertCommand = new SqlCommand(query, connection);
            insertCommand.Parameters.Add("@townName",
                System.Data.SqlDbType.NVarChar, 20).Value = "Razgrad";

            var affectedRows = insertCommand.ExecuteNonQuery();
            Console.WriteLine($"{affectedRows} row affected");
            connection.Close();

            //DELETE
            string deleteQuery = "DELETE FROM Towns WHERE Name = @townName";
            connection.Open();
            var deleteCommand = new SqlCommand(deleteQuery, connection);
            deleteCommand.Parameters.Add("@townName",
                System.Data.SqlDbType.NVarChar).Value = "Razgrad";

            var deletedRows = deleteCommand.ExecuteNonQuery();
            Console.WriteLine($"{deletedRows} rows are deleted");
            connection.Close();

            //UPDATE
            string updateQuery = @"UPDATE Employees
                                   SET Salary = Salary * @raiseSalary
                                   WHERE DepartmentID = @depId AND Salary < @maxSalary";
            connection.Open();
            var updateCommand = new SqlCommand(updateQuery, connection);
            updateCommand.Parameters.Add("@raiseSalary",
                System.Data.SqlDbType.Decimal).Value = 1.10;
            updateCommand.Parameters.Add("@depId",
                System.Data.SqlDbType.Int).Value = 7;
            updateCommand.Parameters.Add("@maxSalary",
                System.Data.SqlDbType.Decimal).Value = 20000;

            var updatedRows = updateCommand.ExecuteNonQuery();
            Console.WriteLine($"{updatedRows} employees updated");
            connection.Close();
            //Count
            string countQuery = @"SELECT COUNT(*)
                                 FROM Employees
                                WHERE DepartmentID = @depId";
            connection.Open();
            var countCommand = new SqlCommand(countQuery, connection);
            countCommand.Parameters.AddWithValue("@depId", 7);

            var employeesCount = countCommand.ExecuteScalar();
            Console.WriteLine($"Employees in dep 7: {employeesCount}");
            connection.Close();
        }
    }
}
